<!DOCTYPE html>
<html>
<head>
    <title>TalkPilot OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Completing Authentication...</h2>
        <p>Please wait while we complete your CRM connection.</p>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        if (error) {
            document.querySelector('.container').innerHTML = `
                <h2>Authentication Failed</h2>
                <p>Error: ${error}</p>
                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer;">Close</button>
            `;
        } else if (code) {
            // Determine which CRM this is for based on the URL
            const isHubSpot = window.location.pathname.includes('hubspot');
            const isSalesforce = window.location.pathname.includes('salesforce');
            
            const provider = isHubSpot ? 'hubspot' : isSalesforce ? 'salesforce' : 'unknown';
            
            // Call the callback API
            fetch(`/api/crm/${provider}/callback?code=${code}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store tokens in chrome.storage
                    if (typeof chrome !== 'undefined' && chrome.storage) {
                        chrome.storage.local.set({
                            [`${provider}AccessToken`]: data.accessToken,
                            [`${provider}RefreshToken`]: data.refreshToken,
                            [`${provider}InstanceUrl`]: data.instanceUrl || null,
                            [`${provider}UserInfo`]: data.userInfo || null
                        }, () => {
                            document.querySelector('.container').innerHTML = `
                                <h2>✅ Authentication Successful!</h2>
                                <p>Your ${provider} account has been connected successfully.</p>
                                <p>You can close this window now.</p>
                                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer;">Close Window</button>
                            `;
                            
                            // Auto-close after 3 seconds
                            setTimeout(() => {
                                window.close();
                            }, 3000);
                        });
                    } else {
                        // Fallback for non-extension context
                        localStorage.setItem(`${provider}AccessToken`, data.accessToken);
                        localStorage.setItem(`${provider}RefreshToken`, data.refreshToken);
                        if (data.instanceUrl) {
                            localStorage.setItem(`${provider}InstanceUrl`, data.instanceUrl);
                        }
                        
                        document.querySelector('.container').innerHTML = `
                            <h2>✅ Authentication Successful!</h2>
                            <p>Your ${provider} account has been connected successfully.</p>
                            <p>You can close this window now.</p>
                            <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer;">Close Window</button>
                        `;
                        
                        setTimeout(() => {
                            window.close();
                        }, 3000);
                    }
                } else {
                    throw new Error(data.error || 'Authentication failed');
                }
            })
            .catch(error => {
                console.error('OAuth callback error:', error);
                document.querySelector('.container').innerHTML = `
                    <h2>❌ Authentication Failed</h2>
                    <p>Error: ${error.message}</p>
                    <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                `;
            });
        } else {
            document.querySelector('.container').innerHTML = `
                <h2>❌ Invalid Callback</h2>
                <p>No authorization code found in the URL.</p>
                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; cursor: pointer;">Close</button>
            `;
        }
    </script>
</body>
</html> 